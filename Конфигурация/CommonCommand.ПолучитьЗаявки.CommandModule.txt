Процедура ПолучитьЗаявкиНаСогласование()
	Перем Соединение;
	Соединение = ОбменСАБФ.ПодключитьСервис();
	тПользователь = Константы.Пользователь.Получить();
	тПароль = Константы.Пароль.Получить();
	Соединение.Пользователь = тПользователь;
	Соединение.Пароль = тПароль;
	Результат = Соединение.ReadTasks(тПользователь,тПароль);
	Данные = Результат.Получить();
	Если ТипЗнч(Данные)=Тип("Структура") тогда
		
		Если Данные.Свойство ("СтатусВозврата")=Неопределено тогда
			Сообщить ("Неверно сформирована структура ответа! Не обнаружен статус возврата. Обратитесь к разработчикам!", СтатусСообщения.ОченьВажное);
			возврат;
		КонецЕсли;
		
		СтатусВозврата = Данные.СтатусВозврата;
		
		Если Не СтатусВозврата Тогда
			Сообщить ("Cервису не удалось сформировать список заявок! Проверьте логин и пароль!", СтатусСообщения.ОченьВажное);
			возврат;
		КонецЕсли;
		
		Если (Данные.Свойство ("ЗаявкиПереданные") = Неопределено) ИЛИ (Данные.Свойство ("НЗ") = Неопределено) тогда
			Сообщить ("Неверно сформирована структура ответа! Не обнаружена таблица с переданными заявками. Обратитесь к разработчикам!", СтатусСообщения.ОченьВажное);
			возврат;
		КонецЕсли;
		
		//прочитаем таблицу с переданными заявками
		тзЗаявкиПереданные 	= Данные.ЗаявкиПереданные;
		рсвЗаявкиПереданные = РегистрыСведений.ЗаявкиПереданные.СоздатьНаборЗаписей();
		рсвЗаявкиПереданные.Загрузить(тзЗаявкиПереданные);
		
		для каждого эл из рсвЗаявкиПереданные цикл
			эл.Состояние = Перечисления.СостояниеЗаявкиПереданные.НеОбработана;
		КонецЦикла;
		
		Попытка
			рсвЗаявкиПереданные.Записать(истина);
		Исключение
			Сообщить ("При загрузке списка переданных заявок возникла ошибка: "+ОписаниеОшибки(),СтатусСообщения.ОченьВажное);
		КонецПопытки;
		
		//прочитаем таблицу с принятыми заявками
		тзЗаявкиПринятые 	= Данные.ЗаявкиПринятые;
		рсвЗаявкиПринятые 	= РегистрыСведений.ЗаявкиПринятые.СоздатьНаборЗаписей();
		рсвЗаявкиПринятые.Загрузить(тзЗаявкиПринятые);
		
		для каждого эл из рсвЗаявкиПринятые цикл
			эл.Состояние = Перечисления.СостояниеЗаявкиПринятые.Принята;
		КонецЦикла;
		
		Попытка
			рсвЗаявкиПринятые.Записать(истина);
		Исключение
			Сообщить ("При загрузке списка принятых заявок возникла ошибка: "+ОписаниеОшибки(),СтатусСообщения.ОченьВажное);
		КонецПопытки;
		
		//прочитаем список наряд-заказов
		Если Данные.Свойство ("НЗ") тогда
			
			тзНЗ	= Данные.НЗ.Скопировать();
			тзНЗ.Свернуть ("ДатаЗаявки, НомерЗаявки, ДатаНЗ, НомерНЗ");
			
			//удалим пустые записи
			к = 0;
			Пока к < тзНЗ.Количество() цикл
				Т = тзНЗ[к];
				Если Не ЗначениеЗаполнено (Т.НомерНЗ) тогда
					тзНЗ.Удалить (Т);
					продолжить;
				КонецЕсли;
				к = к + 1;
			КонецЦикла;
			
			//запишем нз в регистр
			рсвНЗ	= РегистрыСведений.НЗ.СоздатьНаборЗаписей();
			рсвНЗ.Загрузить(тзНЗ);			
			Попытка
				рсвНЗ.Записать(истина);
			Исключение
				Сообщить ("При загрузке списка наряд-заказов произошла ошибка: "+ОписаниеОшибки(), СтатусСообщения.ОченьВажное);
			КонецПопытки;
			
		КонецЕсли;
		//прочитаем содержимое наряд-заказов
		Если Данные.Свойство ("НЗ") тогда
			
			тзСтрНЗ		= Данные.НЗ.Скопировать();
			
			//удалим пустые записи
			к = 0;
			В = ТекущаяДата ();
			Пока к < тзСтрНЗ.Количество() цикл
				Т = тзСтрНЗ[к];
				Если Не ЗначениеЗаполнено (Т.НомерНЗ) тогда
					тзСтрНЗ.Удалить (Т);
					продолжить;
				КонецЕсли;
				Т.Период = В - к; //так мы точно не получим записей с одинковым периодом
				к = к + 1;
			КонецЦикла;
			
			//запишем строки нз в регистр
			рсвСтрНЗ	= РегистрыСведений.СтрокиНЗ.СоздатьНаборЗаписей();
			рсвСтрНЗ.Загрузить(тзСтрНЗ);			
			Попытка
				рсвСтрНЗ.Записать(истина);
			Исключение
				Сообщить ("При загрузке строк наряд-заказов произошла ошибка: "+ОписаниеОшибки(), СтатусСообщения.ОченьВажное);
			КонецПопытки;
			
		КонецЕсли;
	иначе
		Сообщить ("Сервис вернул неверную структуру ответа!",СтатусСообщения.ОченьВажное);
	конецесли;
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	ПолучитьЗаявкиНаСогласование();
	Оповестить ("ЗагруженыЗаявкиПереданные");
КонецПроцедуры
